"use strict";(self.webpackChunkproject_structure=self.webpackChunkproject_structure||[]).push([[460],{842:(e,t,i)=>{function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}i.d(t,{Z:()=>s});class s{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",{duration:t=1e3,type:i="success"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,"element",void 0),n(this,"timerId",void 0),this.message=e,this.duration=t,this.type=i,this.render()}get template(){return`\n      <div class="notification ${this.type}" style="--value:${this.duration/1e3}s">\n        <div class="timer"></div>\n        <div class="inner-wrapper">\n          <div class="notification-header">${this.type}</div>\n          <div class="notification-body">\n            ${this.message}\n          </div>\n        </div>\n      </div>\n    `}render(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild}show(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.body;s.activeNotification&&s.activeNotification.remove(),e.append(this.element),this.timerId=setTimeout(()=>{this.remove()},this.duration,this.element),s.activeNotification=this}remove(){clearTimeout(this.timerId),this.element&&this.element.remove()}destroy(){this.remove(),this.element=null,s.activeNotification=null}}n(s,"activeNotification",void 0)},523:(e,t,i)=>{function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}i.d(t,{Z:()=>s});class s{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,"element",void 0),n(this,"positionShift",5),n(this,"draggingElement",void 0),n(this,"placeholderElement",void 0),n(this,"diffTop",void 0),n(this,"diffLeft",void 0),n(this,"onPointerDown",e=>{e.preventDefault(),e.target.closest("[data-grab-handle]")&&this.onDragItem(e),e.target.closest("[data-delete-handle]")&&this.onDeleteItem(e.target)}),n(this,"onPointerUp",()=>{this.placeholderElement.replaceWith(this.draggingElement),this.draggingElement.classList.remove("sortable-list__item_dragging"),this.draggingElement.removeAttribute("style"),this.placeholderElement=null,this.draggingElement=null,this.dispatchEvent(),document.removeEventListener("pointerup",this.onPointerUp),document.removeEventListener("pointermove",this.onPointerMove)}),n(this,"onPointerMove",e=>{const{clientX:t,clientY:i}=e,n=i-this.diffTop;this.draggingElement.style.top=n+"px",this.draggingElement.style.left=t-this.diffLeft+"px";let{nextElementSibling:s}=this.placeholderElement;const{previousElementSibling:o}=this.placeholderElement,{bottom:r}=this.draggingElement.getBoundingClientRect(),{firstElementChild:l,lastElementChild:a}=this.element,{top:d}=l.getBoundingClientRect(),{bottom:c}=a.getBoundingClientRect();if(s&&s.classList.contains("sortable-list__item_dragging")&&(s=this.draggingElement.nextElementSibling),i<d&&l.before(this.placeholderElement),i>c&&a.after(this.placeholderElement),o){const{top:e,bottom:t,height:s}=o.getBoundingClientRect(),r=e+s/2;i<t&&n<r&&o.before(this.placeholderElement)}if(s){const{top:e,height:t}=s.getBoundingClientRect(),n=e+t/2;i>e&&r>n&&s.after(this.placeholderElement)}}),this.items=e,this.render()}render(){this.element=document.createElement("ul"),this.element.classList.add("sortable-list");const{items:e}=this.items;e.forEach(e=>e.classList.add("sortable-list__item"));for(const t of e)this.element.append(t);this.initEventListeners()}initEventListeners(){this.element.addEventListener("pointerdown",this.onPointerDown)}onDragItem(e){const{clientX:t,clientY:i}=e;this.draggingElement=e.target.closest(".sortable-list__item"),this.modifyDraggingElement(t,i),this.insertPlaceholderItem(),document.addEventListener("pointerup",this.onPointerUp),document.addEventListener("pointermove",this.onPointerMove)}onDeleteItem(e){const t=e.closest(".sortable-list__item");t&&t.remove()}modifyDraggingElement(e,t){const{top:i,left:n,width:s,height:o}=this.draggingElement.getBoundingClientRect(),r=i+this.positionShift,l=n+this.positionShift;this.draggingElement.classList.add("sortable-list__item_dragging"),this.draggingElement.style.top=r+"px",this.draggingElement.style.left=l+"px",this.draggingElement.style.width=s+"px",this.draggingElement.style.height=o+"px",this.diffTop=t-r,this.diffLeft=e-l}insertPlaceholderItem(){const{width:e,height:t}=this.draggingElement.getBoundingClientRect();this.placeholderElement=document.createElement("li"),this.placeholderElement.classList.add("sortable-list__placeholder"),this.placeholderElement.style.width=e+"px",this.placeholderElement.style.height=t+"px",this.draggingElement.before(this.placeholderElement)}dispatchEvent(){this.element.dispatchEvent(new CustomEvent("list-sorted",{bubbles:!0,detail:this.element}))}remove(){this.element&&this.element.remove()}destroy(){this.remove(),this.element=null}}},987:(e,t,i)=>{i.r(t),i.d(t,{default:()=>c});var n=i(523),s=i(842);var o=i(856);function r(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const l="https://course-js.javascript.ru/";class a{constructor(e){r(this,"element",void 0),r(this,"subElements",{}),r(this,"apiCategoriesUrl","api/rest/categories"),r(this,"apiCategoriesParams",{_sort:"weight",_refs:"subcategory"}),r(this,"apiProductUrl","api/rest/products"),r(this,"defaultFormData",{title:"",description:"",quantity:1,subcategory:"",status:1,price:100,discount:0}),r(this,"fileElement",void 0),r(this,"onSubmitClick",async e=>{e.preventDefault(),this.save()}),r(this,"onUploadClick",e=>{e.preventDefault(),this.fileElement=document.createElement("input"),this.fileElement.type="file",this.fileElement.accept="image/*",this.fileElement.hidden=!0,this.element.append(this.fileElement),this.fileElement.click(),this.fileElement.addEventListener("change",this.onFileChange)}),r(this,"onPhotoDeleteClick",e=>{e.target.closest("button")&&e.target.closest("li").remove()}),r(this,"onFileChange",async e=>{const[t]=e.target.files,i=this.element.querySelector('[name="uploadImage"]');i.classList.add("is-loading");const s=await this.uploadImage(t);i.classList.remove("is-loading");const o=this.getImageItem(s.data.link,t.name);if(this.subElements.imageListContainer.firstElementChild)this.subElements.imageListContainer.firstElementChild.append(o);else{const e=new n.Z({items:[o]});this.subElements.imageListContainer.append(e.element)}this.fileElement.remove()}),this.productId=e,this.render()}async render(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element);const t=this.loadCategoriesData(),i=this.productId?this.loadProductData(this.productId):Promise.resolve([this.defaultFormData]),[n,s]=await Promise.all([t,i]),[o]=s;return this.fillCategories(n),this.fillForm(o),this.addEventListeners(),this.element}async loadProductData(e){const t=new URL(this.apiProductUrl,l);t.searchParams.set("id",e);return await(0,o.Z)(t)}async loadCategoriesData(){const e=new URL(this.apiCategoriesUrl,l);for(const t in this.apiCategoriesParams)e.searchParams.set(t,this.apiCategoriesParams[t]);return await(0,o.Z)(e)}async save(){const e=this.getFromData();try{const t=await(0,o.Z)(`${l}${this.apiProductUrl}`,{method:this.productId?"PATCH":"PUT",headers:{"Content-type":"application/json"},body:JSON.stringify(e)});this.dispatchEvent(t.id),this.showNotification("success",`Product ${t.id?"saved":"created"}.`)}catch(e){this.showNotification("error","Something went wrong :( "+e)}}async uploadImage(e){const t=new FormData;t.append("image",e);try{return await(0,o.Z)("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 28aaa2e823b03b1"},body:t,referrer:""})}catch(e){return Promise.reject(e)}}get template(){return`\n    <div class="product-form">\n      <form data-element="productForm" class="form-grid">\n        <div class="form-group form-group__half_left">\n          <fieldset>\n            <label class="form-label">Название товара</label>\n            <input required="" type="text" name="title" id="title" class="form-control" placeholder="Название товара">\n          </fieldset>\n        </div>\n        <div class="form-group form-group__wide">\n          <label class="form-label">Описание</label>\n          <textarea required="" class="form-control" name="description" id="description" data-element="productDescription" placeholder="Описание товара"></textarea>\n        </div>\n        <div class="form-group form-group__wide" data-element="sortable-list-container">\n          <label class="form-label">Фото</label>\n          <div data-element="imageListContainer"></div>\n          <button type="button" name="uploadImage" class="button-primary-outline"><span>Загрузить</span></button>\n        </div>\n        <div class="form-group form-group__half_left">\n          <label class="form-label">Категория</label>\n          <select class="form-control" name="subcategory" id="subcategory"></select>\n        </div>\n        <div class="form-group form-group__half_left form-group__two-col">\n          <fieldset>\n            <label class="form-label">Цена ($)</label>\n            <input required="" type="number" name="price" id="price" class="form-control" placeholder="100">\n          </fieldset>\n          <fieldset>\n            <label class="form-label">Скидка ($)</label>\n            <input required="" type="number" name="discount" id="discount" class="form-control" placeholder="0">\n          </fieldset>\n        </div>\n        <div class="form-group form-group__part-half">\n          <label class="form-label">Количество</label>\n          <input required="" type="number" class="form-control" name="quantity" id="quantity" placeholder="1">\n        </div>\n        <div class="form-group form-group__part-half">\n          <label class="form-label">Статус</label>\n          <select class="form-control" name="status" id="status">\n            <option value="1">Активен</option>\n            <option value="0">Неактивен</option>\n          </select>\n        </div>\n        <div class="form-buttons">\n          <button type="submit" name="save" class="button-primary-outline">\n            ${this.productId?"Сохранить":"Добавить"} товар\n          </button>\n        </div>\n      </form>\n    </div>\n    `}fillCategories(e){const t=this.subElements.productForm.querySelector('[name="subcategory"]');for(const i of e)if(i.subcategories)for(const e of i.subcategories)t.add(new Option(`${i.title} > ${e.title}`,e.id));else t.add(new Option(i.title,i.id))}fillForm(e){const t=Object.keys(this.defaultFormData),i=this.productId?e:this.defaultFormData;for(const e of t){let t=i[e];"string"==typeof t&&(t=t.replace("&amp;","&").replace("&quot;",'"').replace("&#39;","'").replace("&lt;","<").replace("&gt;",">")),this.subElements.productForm.querySelector("#"+e).value=t}i.images&&this.renderImages(i.images)}addEventListeners(){this.subElements.productForm.addEventListener("submit",this.onSubmitClick),this.subElements.imageListContainer.addEventListener("pointerdown",this.onPhotoDeleteClick),this.element.querySelector('[name="uploadImage"]').addEventListener("pointerdown",this.onUploadClick)}renderImages(e){const t=new n.Z({items:e.map(e=>this.getImageItem(e.url,e.source))});this.subElements.imageListContainer.append(t.element)}getImageItem(e,t){const i=document.createElement("li");return i.classList.add("products-edit__imagelist-item","sortable-list__item"),i.innerHTML=`\n      <input type="hidden" name="url" value="${e}">\n      <input type="hidden" name="source" value="${t}">\n      <span>\n        <img src="../../assets/icons/icon-grab.svg" data-grab-handle="" alt="grab">\n        <img class="sortable-table__cell-img" alt="Image" src="${e}">\n        <span>${t}</span>\n      </span>\n      <button type="button">\n       <img src="../../assets/icons/icon-trash.svg" data-delete-handle="" alt="delete">\n      </button>\n    `,i}getSubElements(e){const t={},i=e.querySelectorAll("[data-element]");for(const e of i){t[e.dataset.element]=e}return t}getFromData(){const e={},t=Object.keys(this.defaultFormData);this.productId&&(e.id=this.productId);for(const i of t){const t=this.subElements.productForm.querySelector("#"+i);"number"===t.type||"status"===i?e[i]=parseFloat(t.value):e[i]=t.value.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}e.images=[];const i=this.subElements.imageListContainer.querySelectorAll("li");for(const t of i)e.images.push({source:t.querySelector('[name="source"]').value,url:t.querySelector('[name="url"]').value});return e}dispatchEvent(e){const t=this.productId?new CustomEvent("product-updated",{detail:e}):new CustomEvent("product-saved");this.element.dispatchEvent(t)}showNotification(e,t){new s.Z(t,{type:e,duration:4e3}).show()}remove(){this.element&&this.element.remove()}destroy(){this.remove(),this.element=null}}function d(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class c{constructor(e){d(this,"element",void 0),d(this,"subElements",{}),d(this,"components",{}),this.productId=e[1]||null}async render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element),this.initComponents(),await this.renderComponents(),this.element}get template(){return`<div class="product-edit">\n      <div class="content__top-panel">\n        <h1 class="page-title">\n          <a href="/products" class="link">Товары</a> / ${"add"!==this.productId?"Редактировать":"Добавить"}\n        </h1>\n      </div>\n\n      <div class="content-box">\n        <div data-element="productFrom">\n          \x3c!-- product-form component --\x3e\n        </div>\n      </div>\n    </div>`}initComponents(){this.components.productFrom=new a(this.productId)}renderComponents(){Object.keys(this.components).forEach(e=>{const t=this.subElements[e],{element:i}=this.components[e];t.append(i)})}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}destroy(){for(const e of Object.values(this.components))e.destroy()}}},856:(e,t,i)=>{async function n(e,t){let i,n;try{i=await fetch(e.toString(),t)}catch(e){throw new s(i,"Network error has occurred.")}if(!i.ok){let e=i.statusText;try{n=await i.json(),e=n.error&&n.error.message||n.data&&n.data.error&&n.data.error.message||e}catch(e){}let t=`Error ${i.status}: ${e}`;throw new s(i,n,t)}try{return await i.json()}catch(e){throw new s(i,null,e.message)}}i.d(t,{Z:()=>n});class s extends Error{constructor(e,t,i){var n,s,o;super(i),o="FetchError",(s="name")in(n=this)?Object.defineProperty(n,s,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[s]=o,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof s&&alert(e.reason.message)})}}]);
//# sourceMappingURL=products-edit-index-js-460.js.map