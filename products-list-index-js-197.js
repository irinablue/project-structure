"use strict";(self.webpackChunkproject_structure=self.webpackChunkproject_structure||[]).push([[197],{348:(t,e,s)=>{s.d(e,{Z:()=>r});var n=s(856);function i(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class r{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],{url:e="",sorted:s={id:t.find(t=>t.sortable).id,order:"asc"},isSortLocally:n=!1,step:r=30,start:a=0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,"data",[]),i(this,"element",void 0),i(this,"subElements",void 0),i(this,"arrowElement",void 0),i(this,"filters",{}),i(this,"directions",{asc:1,desc:-1}),i(this,"offset",50),i(this,"loading",!1),i(this,"loadOnScrollAvailable",!0),i(this,"sortOnServer",async(t,e)=>{this.end=this.step;const s=await this.loadData(t,e,this.start,this.step);this.update(s,!1)}),i(this,"render",async()=>{const{id:t,order:e}=this.sorted,s=document.createElement("div");s.innerHTML=this.template,this.element=s.firstElementChild,this.subElements=this.getSubElements(this.element);const n=document.createElement("div");n.innerHTML='\n      <span data-element="arrow" class="sortable-table__sort-arrow">\n        <span class="sort-arrow"></span>\n      </span>\n    ',this.arrowElement=n.firstElementChild;const i=await this.loadData(t,e,this.start,this.end);this.update(i),this.addOrderToCell(t,e),this.addEventListener()}),i(this,"onSortableCellClick",t=>{if(t.target.closest('[data-sortable="true"]')){const e=t.target.closest("[data-sortable]").dataset.id,s=this.subElements.header.querySelector("[data-order]"),n=s?this.getTargetOrder(s.dataset.order):"asc";this.sort(e,n)}}),i(this,"onWindowScroll",async()=>{if(this.element){const{bottom:t}=this.element.getBoundingClientRect();if(this.loadOnScrollAvailable&&!this.isSortLocally&&!this.loading&&t<document.documentElement.clientHeight){const{id:t,order:e}=this.sorted;this.start=this.end,this.end=this.start+this.step,this.loading=!0;const s=await this.loadData(t,e,this.start,this.end);this.update(s),this.loading=!1}}}),this.headerConfig=t,this.url=new URL(e,"https://course-js.javascript.ru/"),this.sorted=s,this.isSortLocally=n,this.start=a,this.step=r,this.end=this.start+this.step,this.render()}get template(){return`\n      <div data-element="productsContainer" class="products-list__container">\n        ${this.getTable()}\n      </div>\n    `}async loadData(t,e,s,i){this.url.searchParams.set("_sort",t),this.url.searchParams.set("_order",e),this.url.searchParams.set("_start",s),this.url.searchParams.set("_end",i);for(const[t,e]of Object.entries(this.filters))(e||0===e)&&this.url.searchParams.set(t,e.toString());this.subElements.table.classList.add("sortable-table_loading");const r=await(0,n.Z)(this.url);return this.subElements.table.classList.remove("sortable-table_loading"),this.loadOnScrollAvailable=r.length===this.step,r}addOrderToCell(t,e){const s=this.subElements.header.querySelector(`[data-id=${t}]`);s&&(s.append(this.arrowElement),s.setAttribute("data-order",e))}sort(t,e){const s=this.subElements.header.querySelector("[data-order]");s&&s.removeAttribute("data-order"),this.addOrderToCell(t,e),this.start=0,this.sorted={id:t,order:e},this.isSortLocally?this.sortOnClient(t,e):this.sortOnServer(t,e)}sortOnClient(t,e){const s=this.headerConfig.find(e=>e.id===t),n=s?s.sortType:"number",i=this.directions[e],r=[...this.data].sort((e,s)=>{switch(n){case"number":return i*(e[t]-s[t]);case"string":return i*e[t].localeCompare(s[t],["ru","en"],{caseFirst:"upper"})}});this.update(r,!1)}getTableHead(){return`\n      <div data-element="header" class="sortable-table__header sortable-table__row">\n        ${this.headerConfig.map(t=>`\n        <div class="sortable-table__cell" data-id="${t.id}" data-sortable="${t.sortable}">\n          <span>${t.title}</span>\n        </div>\n      `).join("")}\n      </div>\n    `}getTableRow(t){const e=this.headerConfig.map(e=>e.template?e.template(t[e.id]):`\n        <div class="sortable-table__cell">${t[e.id]}</div>\n      `);return`\n      <a href="/products/${t.id}" class="sortable-table__row">\n        ${e.join("")}\n      </a>\n    `}getTableBody(){return`\n      <div data-element="body" class="sortable-table__body">\n        ${this.getRowsHtml()}\n      </div>\n    `}getTable(){return`\n      <div data-element="table" class="sortable-table sortable-table_loading">\n        ${this.getTableHead()}\n        ${this.getTableBody()}\n\n        <div data-element="loading" class="loading-line sortable-table__loading-line"></div>\n\n        <div data-element="emptyPlaceholder" class="sortable-table__empty-placeholder">\n          <div>\n            <p>No products satisfies your filter criteria</p>\n            <button type="button" class="button-primary-outline">Reset all filters</button>\n          </div>\n        </div>\n      </div>\n    `}getSubElements(t){const e={},s=t.querySelectorAll("[data-element]");for(const t of s){e[t.dataset.element]=t}return e}getRowsHtml(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.data).map(t=>this.getTableRow(t)).join("")}addEventListener(){this.subElements.header.addEventListener("pointerdown",this.onSortableCellClick),window.addEventListener("scroll",this.onWindowScroll)}update(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];t&&Object.values(t).length?(this.subElements.table.classList.remove("sortable-table_empty"),e?this.subElements.body.innerHTML+=this.getRowsHtml(t):this.subElements.body.innerHTML=this.getRowsHtml(t)):e||this.subElements.table.classList.add("sortable-table_empty"),this.data=t}getTargetOrder(t){return{asc:"desc",desc:"asc"}[t]}destroy(){this.element&&this.element.remove(),window.removeEventListener("scroll",this.onWindowScroll),this.element=null}}},21:(t,e,s)=>{s.r(e),s.d(e,{default:()=>h});var n=s(348);function i(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class r{constructor(){let{min:t=100,max:e=200,formatValue:s=(t=>"$"+t),selected:n={from:t,to:e}}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,"element",void 0),i(this,"subElements",{}),i(this,"onThumbPointerMove",t=>{t.preventDefault();const{left:e,right:s,width:n}=this.subElements.inner.getBoundingClientRect();if(this.dragging===this.subElements.thumbLeft){let s=(t.clientX-e+this.shiftX)/n;s<0&&(s=0),s*=100;const i=parseFloat(this.subElements.thumbRight.style.right);s+i>100&&(s=100-i),this.dragging.style.left=this.subElements.progress.style.left=s+"%",this.subElements.from.innerHTML=this.formatValue(this.getValue().from)}if(this.dragging===this.subElements.thumbRight){let e=(s-t.clientX-this.shiftX)/n;e<0&&(e=0),e*=100;const i=parseFloat(this.subElements.thumbLeft.style.left);i+e>100&&(e=100-i),this.dragging.style.right=this.subElements.progress.style.right=e+"%",this.subElements.to.innerHTML=this.formatValue(this.getValue().to)}}),i(this,"onThumbPointerUp",()=>{this.element.classList.remove("range-slider_dragging"),document.removeEventListener("pointermove",this.onThumbPointerMove),document.removeEventListener("pointerup",this.onThumbPointerUp),this.element.dispatchEvent(new CustomEvent("range-select",{detail:this.getValue(),bubbles:!0}))}),this.min=t,this.max=e,this.formatValue=s,this.selected=n,this.render()}get template(){const{from:t,to:e}=this.selected;return`<div class="range-slider">\n      <span data-element="from">${this.formatValue(t)}</span>\n      <div data-element="inner" class="range-slider__inner">\n        <span data-element="progress" class="range-slider__progress"></span>\n        <span data-element="thumbLeft" class="range-slider__thumb-left"></span>\n        <span data-element="thumbRight" class="range-slider__thumb-right"></span>\n      </div>\n      <span data-element="to">${this.formatValue(e)}</span>\n    </div>`}render(){const t=document.createElement("div");t.innerHTML=this.template,this.element=t.firstElementChild,this.element.ondragstart=()=>!1,this.subElements=this.getSubElements(t),this.initEventListeners(),this.update()}initEventListeners(){const{thumbLeft:t,thumbRight:e}=this.subElements;t.addEventListener("pointerdown",t=>this.onThumbPointerDown(t)),e.addEventListener("pointerdown",t=>this.onThumbPointerDown(t))}getSubElements(t){const e={},s=t.querySelectorAll("[data-element]");for(const t of s){e[t.dataset.element]=t}return e}remove(){this.element.remove()}destroy(){this.remove(),document.removeEventListener("pointermove",this.onThumbPointerMove),document.removeEventListener("pointerup",this.onThumbPointerUp)}update(){const t=this.max-this.min,e=Math.floor((this.selected.from-this.min)/t*100)+"%",s=Math.floor((this.max-this.selected.to)/t*100)+"%";this.subElements.progress.style.left=e,this.subElements.progress.style.right=s,this.subElements.thumbLeft.style.left=e,this.subElements.thumbRight.style.right=s,this.subElements.from.innerText=this.formatValue(this.min),this.subElements.to.innerText=this.formatValue(this.max)}onThumbPointerDown(t){const e=t.target;t.preventDefault();const{left:s,right:n}=e.getBoundingClientRect();e===this.subElements.thumbLeft?this.shiftX=n-t.clientX:this.shiftX=s-t.clientX,this.dragging=e,this.element.classList.add("range-slider_dragging"),document.addEventListener("pointermove",this.onThumbPointerMove),document.addEventListener("pointerup",this.onThumbPointerUp)}getValue(){const t=this.max-this.min,{left:e}=this.subElements.thumbLeft.style,{right:s}=this.subElements.thumbRight.style;return{from:Math.round(this.min+.01*parseFloat(e)*t),to:Math.round(this.max-.01*parseFloat(s)*t)}}}const a=[{id:"images",title:"Image",sortable:!1,template:t=>`\n          <div class="sortable-table__cell">\n            <img class="sortable-table-image" alt="Image" src="${t[0].url}">\n          </div>\n        `},{id:"title",title:"Name",sortable:!0,sortType:"string"},{id:"subcategory",title:"Category",sortable:!1,template:t=>`<div class="sortable-table__cell">\n          ${t.title}\n        </div>`},{id:"quantity",title:"Quantity",sortable:!0,sortType:"number"},{id:"price",title:"Price",sortable:!0,sortType:"number",template:t=>`<div class="sortable-table__cell">\n          $${t.toLocaleString("en-US")}\n        </div>`},{id:"status",title:"Status",sortable:!0,sortType:"number",template:t=>`<div class="sortable-table__cell">\n          ${t>0?"Active":"Inactive"}\n        </div>`}];var l=s(856);function o(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const d="api/rest/products?_embed=subcategory.category";class h{constructor(){o(this,"element",void 0),o(this,"subElements",{}),o(this,"components",{}),o(this,"loadStep",30),o(this,"loadStart",0),o(this,"sliderMin",1e3),o(this,"sliderMax",4e3),o(this,"clearFilters",()=>{this.subElements.filterName.value="",this.subElements.filterStatus.value="",this.components.sliderContainer.min=this.sliderMin,this.components.sliderContainer.max=this.sliderMax,this.components.sliderContainer.update(),this.updateTableComponent()})}async render(){const t=document.createElement("div");return t.innerHTML=this.template,this.element=t.firstElementChild,this.subElements=this.getSubElements(this.element),this.initComponents(),await this.renderComponents(),this.subElements=this.getSubElements(this.element),this.initEventListeners(),this.element}async updateTableComponent(){const t=this.getParamsFromForm(),{status:e,title_like:s,price_lte:n,price_gte:i}=t,{sorted:r}=this.components.sortableTable;this.components.sortableTable.filters=t;const a=new URL(d,"https://course-js.javascript.ru/");a.searchParams.set("_sort",r.id),a.searchParams.set("_order",r.order),a.searchParams.set("_start",this.loadStart.toString()),a.searchParams.set("_end",this.loadStep.toString()),a.searchParams.set("price_lte",n),a.searchParams.set("price_gte",i),e&&a.searchParams.set("status",e),s&&a.searchParams.set("title_like",s);const o=await(0,l.Z)(a);this.components.sortableTable.update(o,!1)}get template(){return'<div class="product-list">\n      <div class="content__top-panel">\n        <h2 class="page-title">Products</h2>\n        <a href="/products/add" class="button-primary">Добавить товар</a>\n      </div>\n\n      <div class="content-box content-box_small">\n        <form class="form-inline">\n          <div class="form-group">\n            <label class="form-label">Сортировать по:</label>\n            <input type="text" data-element="filterName" class="form-control" placeholder="Название товара">\n          </div>\n          <div class="form-group" data-element="sliderContainer">\n            <label class="form-label">Цена:</label>\n          </div>\n          <div class="form-group">\n            <label class="form-label">Статус:</label>\n            <select class="form-control" data-element="filterStatus">\n              <option value="" selected="">Любой</option>\n              <option value="1">Активный</option>\n              <option value="0">Неактивный</option>\n            </select>\n          </div>\n        </form>\n      </div>\n\n      <div data-element="sortableTable">\n        \x3c!-- sortable-table component --\x3e\n      </div>\n    </div>'}initComponents(){const t=new n.Z(a,{url:d,sorted:{id:"title",order:"asc"},start:this.loadStart,step:this.loadStep,isSortLocally:!1}),e=new r({min:this.sliderMin,max:this.sliderMax});this.components.sortableTable=t,this.components.sliderContainer=e}renderComponents(){Object.keys(this.components).forEach(t=>{const e=this.subElements[t],{element:s}=this.components[t];e.append(s)})}getSubElements(t){return[...t.querySelectorAll("[data-element]")].reduce((t,e)=>(t[e.dataset.element]=e,t),{})}initEventListeners(){this.subElements.emptyPlaceholder.querySelector("button").addEventListener("pointerdown",this.clearFilters),this.subElements.filterStatus.addEventListener("change",()=>{this.updateTableComponent()}),this.subElements.filterName.addEventListener("input",()=>{this.updateTableComponent()}),this.components.sliderContainer.element.addEventListener("range-select",()=>{this.updateTableComponent()})}getParamsFromForm(){const t={},{from:e,to:s}=this.components.sliderContainer.getValue();return t.price_lte=s,t.price_gte=e,t.status=this.subElements.filterStatus.value,t.title_like=this.subElements.filterName.value,t}destroy(){for(const t of Object.values(this.components))t.destroy()}}},856:(t,e,s)=>{async function n(t,e){let s,n;try{s=await fetch(t.toString(),e)}catch(t){throw new i(s,"Network error has occurred.")}if(!s.ok){let t=s.statusText;try{n=await s.json(),t=n.error&&n.error.message||n.data&&n.data.error&&n.data.error.message||t}catch(t){}let e=`Error ${s.status}: ${t}`;throw new i(s,n,e)}try{return await s.json()}catch(t){throw new i(s,null,t.message)}}s.d(e,{Z:()=>n});class i extends Error{constructor(t,e,s){var n,i,r;super(s),r="FetchError",(i="name")in(n=this)?Object.defineProperty(n,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[i]=r,this.response=t,this.body=e}}window.addEventListener("unhandledrejection",t=>{t.reason instanceof i&&alert(t.reason.message)})}}]);
//# sourceMappingURL=products-list-index-js-197.js.map