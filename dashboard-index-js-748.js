"use strict";(self.webpackChunkproject_structure=self.webpackChunkproject_structure||[]).push([[748],{552:(e,t,s)=>{function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,{Z:()=>a});class a{static formatDate(e){return e.toLocaleString("ru",{dateStyle:"short"})}constructor(){let{from:e=new Date,to:t=new Date}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,"element",null),n(this,"subElements",{}),n(this,"selectingFrom",!0),n(this,"selected",{from:new Date,to:new Date}),n(this,"onDocumentClick",e=>{const t=this.element.classList.contains("rangepicker_open"),s=this.element.contains(e.target);t&&!s&&this.close()}),this.showDateFrom=new Date(e),this.selected={from:e,to:t},this.render()}get template(){return`<div class="rangepicker">\n      <div class="rangepicker__input" data-elem="input">\n        <span data-elem="from">${a.formatDate(this.selected.from)}</span> -\n        <span data-elem="to">${a.formatDate(this.selected.to)}</span>\n      </div>\n      <div class="rangepicker__selector" data-elem="selector"></div>\n    </div>`}render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(e),this.initEventListeners(),Promise.resolve(this.element)}getSubElements(e){const t={};for(const s of e.querySelectorAll("[data-elem]"))t[s.dataset.elem]=s;return t}initEventListeners(){const{input:e,selector:t}=this.subElements;document.addEventListener("click",this.onDocumentClick,!0),e.addEventListener("click",()=>this.toggle()),t.addEventListener("click",e=>this.onSelectorClick(e))}toggle(){this.element.classList.toggle("rangepicker_open"),this.renderDateRangePicker()}onSelectorClick(e){let{target:t}=e;t.classList.contains("rangepicker__cell")&&this.onRangePickerCellClick(t)}close(){this.element.classList.remove("rangepicker_open")}renderDateRangePicker(){const e=new Date(this.showDateFrom),t=new Date(this.showDateFrom),{selector:s}=this.subElements;t.setMonth(t.getMonth()+1),s.innerHTML=`\n      <div class="rangepicker__selector-arrow"></div>\n      <div class="rangepicker__selector-control-left"></div>\n      <div class="rangepicker__selector-control-right"></div>\n      ${this.renderCalendar(e)}\n      ${this.renderCalendar(t)}\n    `;const n=s.querySelector(".rangepicker__selector-control-left"),a=s.querySelector(".rangepicker__selector-control-right");n.addEventListener("click",()=>this.prev()),a.addEventListener("click",()=>this.next()),this.renderHighlight()}prev(){this.showDateFrom.setMonth(this.showDateFrom.getMonth()-1),this.renderDateRangePicker()}next(){this.showDateFrom.setMonth(this.showDateFrom.getMonth()+1),this.renderDateRangePicker()}renderHighlight(){const{from:e,to:t}=this.selected;for(const s of this.element.querySelectorAll(".rangepicker__cell")){const{value:n}=s.dataset,a=new Date(n);s.classList.remove("rangepicker__selected-from"),s.classList.remove("rangepicker__selected-between"),s.classList.remove("rangepicker__selected-to"),e&&n===e.toISOString()?s.classList.add("rangepicker__selected-from"):t&&n===t.toISOString()?s.classList.add("rangepicker__selected-to"):e&&t&&a>=e&&a<=t&&s.classList.add("rangepicker__selected-between")}if(e){const t=this.element.querySelector(`[data-value="${e.toISOString()}"]`);t&&t.closest(".rangepicker__cell").classList.add("rangepicker__selected-from")}if(t){const e=this.element.querySelector(`[data-value="${t.toISOString()}"]`);e&&e.closest(".rangepicker__cell").classList.add("rangepicker__selected-to")}}renderCalendar(e){const t=new Date(e);t.setDate(1);const s=t.toLocaleString("ru",{month:"long"});let n=`<div class="rangepicker__calendar">\n      <div class="rangepicker__month-indicator">\n        <time datetime=${s}>${s}</time>\n      </div>\n      <div class="rangepicker__day-of-week">\n        <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>\n      </div>\n      <div class="rangepicker__date-grid">\n    `;var a;for(n+=`\n      <button type="button"\n        class="rangepicker__cell"\n        data-value="${t.toISOString()}"\n        style="--start-from: ${a=t.getDay(),1+(0===a?6:a-1)}">\n          ${t.getDate()}\n      </button>`,t.setDate(2);t.getMonth()===e.getMonth();)n+=`\n        <button type="button"\n          class="rangepicker__cell"\n          data-value="${t.toISOString()}">\n            ${t.getDate()}\n        </button>`,t.setDate(t.getDate()+1);return n+="</div></div>",n}onRangePickerCellClick(e){const{value:t}=e.dataset;if(t){const e=new Date(t);this.selectingFrom?(this.selected={from:e,to:null},this.selectingFrom=!1,this.renderHighlight()):(e>this.selected.from?this.selected.to=e:(this.selected.to=this.selected.from,this.selected.from=e),this.selectingFrom=!0,this.renderHighlight()),this.selected.from&&this.selected.to&&(this.dispatchEvent(),this.close(),this.subElements.from.innerHTML=a.formatDate(this.selected.from),this.subElements.to.innerHTML=a.formatDate(this.selected.to))}}dispatchEvent(){this.element.dispatchEvent(new CustomEvent("date-select",{bubbles:!0,detail:this.selected}))}remove(){this.element.remove(),document.removeEventListener("click",this.onDocumentClick,!0)}destroy(){return this.remove(),this.element=null,this.subElements={},this.selectingFrom=!0,this.selected={from:new Date,to:new Date},this}}},348:(e,t,s)=>{s.d(t,{Z:()=>r});var n=s(856);function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class r{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],{url:t="",sorted:s={id:e.find(e=>e.sortable).id,order:"asc"},isSortLocally:n=!1,step:r=30,start:i=0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};a(this,"data",[]),a(this,"element",void 0),a(this,"subElements",void 0),a(this,"arrowElement",void 0),a(this,"filters",{}),a(this,"directions",{asc:1,desc:-1}),a(this,"offset",50),a(this,"loading",!1),a(this,"loadOnScrollAvailable",!0),a(this,"sortOnServer",async(e,t)=>{this.end=this.step;const s=await this.loadData(e,t,this.start,this.step);this.update(s,!1)}),a(this,"render",async()=>{const{id:e,order:t}=this.sorted,s=document.createElement("div");s.innerHTML=this.template,this.element=s.firstElementChild,this.subElements=this.getSubElements(this.element);const n=document.createElement("div");n.innerHTML='\n      <span data-element="arrow" class="sortable-table__sort-arrow">\n        <span class="sort-arrow"></span>\n      </span>\n    ',this.arrowElement=n.firstElementChild;const a=await this.loadData(e,t,this.start,this.end);this.update(a),this.addOrderToCell(e,t),this.addEventListener()}),a(this,"onSortableCellClick",e=>{if(e.target.closest('[data-sortable="true"]')){const t=e.target.closest("[data-sortable]").dataset.id,s=this.subElements.header.querySelector("[data-order]"),n=s?this.getTargetOrder(s.dataset.order):"asc";this.sort(t,n)}}),a(this,"onWindowScroll",async()=>{if(this.element){const{bottom:e}=this.element.getBoundingClientRect();if(this.loadOnScrollAvailable&&!this.isSortLocally&&!this.loading&&e<document.documentElement.clientHeight){const{id:e,order:t}=this.sorted;this.start=this.end,this.end=this.start+this.step,this.loading=!0;const s=await this.loadData(e,t,this.start,this.end);this.update(s),this.loading=!1}}}),this.headerConfig=e,this.url=new URL(t,"https://course-js.javascript.ru/"),this.sorted=s,this.isSortLocally=n,this.start=i,this.step=r,this.end=this.start+this.step,this.render()}get template(){return`\n      <div data-element="productsContainer" class="products-list__container">\n        ${this.getTable()}\n      </div>\n    `}async loadData(e,t,s,a){this.url.searchParams.set("_sort",e),this.url.searchParams.set("_order",t),this.url.searchParams.set("_start",s),this.url.searchParams.set("_end",a);for(const[e,t]of Object.entries(this.filters))(t||0===t)&&this.url.searchParams.set(e,t.toString());this.subElements.table.classList.add("sortable-table_loading");const r=await(0,n.Z)(this.url);return this.subElements.table.classList.remove("sortable-table_loading"),this.loadOnScrollAvailable=r.length===this.step,r}addOrderToCell(e,t){const s=this.subElements.header.querySelector(`[data-id=${e}]`);s&&(s.append(this.arrowElement),s.setAttribute("data-order",t))}sort(e,t){const s=this.subElements.header.querySelector("[data-order]");s&&s.removeAttribute("data-order"),this.addOrderToCell(e,t),this.start=0,this.sorted={id:e,order:t},this.isSortLocally?this.sortOnClient(e,t):this.sortOnServer(e,t)}sortOnClient(e,t){const s=this.headerConfig.find(t=>t.id===e),n=s?s.sortType:"number",a=this.directions[t],r=[...this.data].sort((t,s)=>{switch(n){case"number":return a*(t[e]-s[e]);case"string":return a*t[e].localeCompare(s[e],["ru","en"],{caseFirst:"upper"})}});this.update(r,!1)}getTableHead(){return`\n      <div data-element="header" class="sortable-table__header sortable-table__row">\n        ${this.headerConfig.map(e=>`\n        <div class="sortable-table__cell" data-id="${e.id}" data-sortable="${e.sortable}">\n          <span>${e.title}</span>\n        </div>\n      `).join("")}\n      </div>\n    `}getTableRow(e){const t=this.headerConfig.map(t=>t.template?t.template(e[t.id]):`\n        <div class="sortable-table__cell">${e[t.id]}</div>\n      `);return`\n      <a href="/products/${e.id}" class="sortable-table__row">\n        ${t.join("")}\n      </a>\n    `}getTableBody(){return`\n      <div data-element="body" class="sortable-table__body">\n        ${this.getRowsHtml()}\n      </div>\n    `}getTable(){return`\n      <div data-element="table" class="sortable-table sortable-table_loading">\n        ${this.getTableHead()}\n        ${this.getTableBody()}\n\n        <div data-element="loading" class="loading-line sortable-table__loading-line"></div>\n\n        <div data-element="emptyPlaceholder" class="sortable-table__empty-placeholder">\n          <div>\n            <p>No products satisfies your filter criteria</p>\n            <button type="button" class="button-primary-outline">Reset all filters</button>\n          </div>\n        </div>\n      </div>\n    `}getSubElements(e){const t={},s=e.querySelectorAll("[data-element]");for(const e of s){t[e.dataset.element]=e}return t}getRowsHtml(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.data).map(e=>this.getTableRow(e)).join("")}addEventListener(){this.subElements.header.addEventListener("pointerdown",this.onSortableCellClick),window.addEventListener("scroll",this.onWindowScroll)}update(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e&&Object.values(e).length?(this.subElements.table.classList.remove("sortable-table_empty"),t?this.subElements.body.innerHTML+=this.getRowsHtml(e):this.subElements.body.innerHTML=this.getRowsHtml(e)):t||this.subElements.table.classList.add("sortable-table_empty"),this.data=e}getTargetOrder(e){return{asc:"desc",desc:"asc"}[e]}destroy(){this.element&&this.element.remove(),window.removeEventListener("scroll",this.onWindowScroll),this.element=null}}},329:(e,t,s)=>{s.r(t),s.d(t,{default:()=>c});var n=s(552),a=s(348);function r(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class i{constructor(){let{data:e=[],label:t="",link:s="",value:n=0,range:a={from:new Date,to:new Date},formatHeading:i=(e=>e)}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,"chartHeight",50),r(this,"subElements",{}),r(this,"loadingCssClass","column-chart_loading"),this.label=t,this.link=s,this.value=n,this.range=a,this.data=e,this.formatHeading=i,this.render(),this.update({bodyData:this.data})}get template(){return`\n      <div class="column-chart ${this.loadingCssClass}" style="--chart-height: ${this.chartHeight}">\n        <div class="column-chart__title">\n          Total ${this.label}\n          ${this.renderLink()}\n        </div>\n        <div class="column-chart__container">\n          <div data-element="header" class="column-chart__header">${this.renderHeader()}</div>\n          <div data-element="body" class="column-chart__chart">\n            ${this.renderCol()}\n          </div>\n        </div>\n      </div>\n    `}renderHeader(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.data;const t=Object.values(e).reduce((e,t)=>e+t,0);return this.formatHeading(t)}renderCol(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.data;const t=Object.values(e),s=Math.max(...t),n=this.chartHeight/s;return t.map(e=>{const t=(e/s*100).toFixed(0)+"%";return`<div style="--value: ${String(Math.floor(e*n))}" data-tooltip="${t}"></div>`}).join("")}renderLink(){return this.link?`<a href="${this.link}" class="column-chart__link">View all</a>`:""}getSubElements(e){const t={},s=e.querySelectorAll("[data-element]");for(const e of s){t[e.dataset.element]=e}return t}render(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element)}async update(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.element.classList.add(this.loadingCssClass);const{headerData:t,bodyData:s}=e;return s&&Object.values(s).length&&(this.subElements.header.innerHTML=t||this.renderHeader(s),this.subElements.body.innerHTML=this.renderCol(s),this.element.classList.remove(this.loadingCssClass)),this.data=s,this.data}remove(){this.element&&this.element.remove()}destroy(){this.remove(),this.element=null}}const l=[{id:"images",title:"Image",sortable:!1,template:e=>`\n          <div class="sortable-table__cell">\n            <img class="sortable-table-image" alt="Image" src="${e[0].url}">\n          </div>\n        `},{id:"title",title:"Name",sortable:!0,sortType:"string"},{id:"quantity",title:"Quantity",sortable:!0,sortType:"number"},{id:"price",title:"Price",sortable:!0,sortType:"number",template:e=>`<div class="sortable-table__cell">\n          $${e.toLocaleString("en-US")}\n        </div>`},{id:"status",title:"Status",sortable:!0,sortType:"number",template:e=>`<div class="sortable-table__cell">\n          ${e>0?"Active":"Inactive"}\n        </div>`}];var o=s(856);function d(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class c{constructor(){d(this,"element",void 0),d(this,"subElements",{}),d(this,"components",{})}async getDataForColumnCharts(e,t){const s=`https://course-js.javascript.ru/api/dashboard/orders?from=${e.toISOString()}&to=${t.toISOString()}`,n=`https://course-js.javascript.ru/api/dashboard/sales?from=${e.toISOString()}&to=${t.toISOString()}`,a=`https://course-js.javascript.ru/api/dashboard/customers?from=${encodeURIComponent(e.toISOString())}&to=${encodeURIComponent(t.toISOString())}`,r=(0,o.Z)(s),i=(0,o.Z)(n),l=(0,o.Z)(a);return(await Promise.all([r,i,l])).map(e=>Object.values(e))}async updateTableComponent(e,t){const s=await(0,o.Z)(`https://course-js.javascript.ru/api/dashboard/bestsellers?_start=1&_end=20&from=${e.toISOString()}&to=${t.toISOString()}`);this.components.sortableTable.update(s,!1)}async updateChartsComponents(e,t){const[s,n,a]=await this.getDataForColumnCharts(e,t),r=s.reduce((e,t)=>e+t),i=n.reduce((e,t)=>e+t),l=a.reduce((e,t)=>e+t);this.components.ordersChart.update({headerData:r,bodyData:s}),this.components.salesChart.update({headerData:"$"+i,bodyData:n}),this.components.customersChart.update({headerData:l,bodyData:a})}async initComponents(){const e=new Date,t=new Date;t.setMonth(e.getMonth()-1);const[s,r,o]=await this.getDataForColumnCharts(t,e),d=new n.Z({from:t,to:e}),c=new a.Z(l,{url:`api/dashboard/bestsellers?_start=1&_end=20&from=${t.toISOString()}&to=${e.toISOString()}`,isSortLocally:!0}),h=new i({data:s,label:"orders",value:s.reduce((e,t)=>e+t),link:"#"}),m=new i({data:r,label:"sales",value:"$"+r.reduce((e,t)=>e+t),formatHeading:e=>"$"+e.toLocaleString("en-US")}),u=new i({data:o,label:"customers",value:o.reduce((e,t)=>e+t)});this.components.sortableTable=c,this.components.ordersChart=h,this.components.salesChart=m,this.components.customersChart=u,this.components.rangePicker=d}get template(){return'<div class="dashboard">\n      <div class="content__top-panel">\n        <h2 class="page-title">Dashboard</h2>\n        \x3c!-- RangePicker component --\x3e\n        <div data-element="rangePicker"></div>\n      </div>\n      <div data-element="chartsRoot" class="dashboard__charts">\n        \x3c!-- column-chart components --\x3e\n        <div data-element="ordersChart" class="dashboard__chart_orders"></div>\n        <div data-element="salesChart" class="dashboard__chart_sales"></div>\n        <div data-element="customersChart" class="dashboard__chart_customers"></div>\n      </div>\n\n      <h3 class="block-title">Best sellers</h3>\n\n      <div data-element="sortableTable">\n        \x3c!-- sortable-table component --\x3e\n      </div>\n    </div>'}async render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element),await this.initComponents(),this.renderComponents(),this.initEventListeners(),this.element}renderComponents(){Object.keys(this.components).forEach(e=>{const t=this.subElements[e],{element:s}=this.components[e];t.append(s)})}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}initEventListeners(){this.components.rangePicker.element.addEventListener("date-select",e=>{const{from:t,to:s}=e.detail;this.updateChartsComponents(t,s),this.updateTableComponent(t,s)})}destroy(){for(const e of Object.values(this.components))e.destroy()}}},856:(e,t,s)=>{async function n(e,t){let s,n;try{s=await fetch(e.toString(),t)}catch(e){throw new a(s,"Network error has occurred.")}if(!s.ok){let e=s.statusText;try{n=await s.json(),e=n.error&&n.error.message||n.data&&n.data.error&&n.data.error.message||e}catch(e){}let t=`Error ${s.status}: ${e}`;throw new a(s,n,t)}try{return await s.json()}catch(e){throw new a(s,null,e.message)}}s.d(t,{Z:()=>n});class a extends Error{constructor(e,t,s){var n,a,r;super(s),r="FetchError",(a="name")in(n=this)?Object.defineProperty(n,a,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[a]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof a&&alert(e.reason.message)})}}]);
//# sourceMappingURL=dashboard-index-js-748.js.map